<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#6a11cb">
    <title>音乐盒修复</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-text-size-adjust: 100%;
        }
        
        html {
            height: -webkit-fill-available;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #333;
            overflow-x: hidden;
        }
        
        .experience-container {
            width: 100%;
            max-width: 900px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            padding: 20px;
            position: relative;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        
        h1 {
            color: #4a00e0;
            font-size: clamp(1.8rem, 5vw, 2.5rem);
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .experience-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            gap: 10px;
        }
        
        .part-info, .progress-info {
            font-size: clamp(1rem, 3vw, 1.2rem);
            font-weight: bold;
            color: #4a00e0;
            text-align: center;
            flex: 1;
        }
        
        .experience-area {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .music-box-container {
            flex: 1;
            min-width: 280px;
            background: #fff;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .music-box {
            width: 100%;
            max-width: 250px;
            height: 250px;
            margin: 0 auto 20px;
            background: linear-gradient(145deg, #8e2de2, #4a00e0);
            border-radius: 15px;
            position: relative;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
            overflow: hidden;
            touch-action: manipulation;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .music-box::before {
            content: "";
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
        
        .toolbox {
            flex: 1;
            min-width: 280px;
            background: #fff;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .toolbox h2 {
            text-align: center;
            margin-bottom: 15px;
            color: #4a00e0;
            font-size: clamp(1.3rem, 4vw, 1.5rem);
        }
        
        .tools {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
        }
        
        .tool {
            width: 70px;
            height: 70px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            font-size: 1.5rem;
            user-select: none;
            -webkit-user-select: none;
            position: relative;
            overflow: hidden;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .tool:active {
            transform: scale(0.95);
        }
        
        .tool:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .tool.spring { background: #ffeb3b; }
        .tool.gear { background: #e0e0e0; }
        .tool.key { background: #ff9800; }
        .tool.cylinder { background: #795548; color: white; }
        
        .tool.selected {
            box-shadow: 0 0 0 3px #4a00e0, 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .tool img {
            width: 50px;
            height: 50px;
            object-fit: contain;
            pointer-events: none;
        }
        
        .instructions {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 15px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .instructions h2 {
            color: #4a00e0;
            margin-bottom: 10px;
            font-size: clamp(1.2rem, 3.5vw, 1.3rem);
        }
        
        .instructions p {
            margin-bottom: 8px;
            line-height: 1.4;
            font-size: clamp(0.9rem, 2.5vw, 1rem);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 50px;
            background: linear-gradient(145deg, #8e2de2, #4a00e0);
            color: white;
            font-size: clamp(0.9rem, 2.5vw, 1rem);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            min-height: 44px;
            min-width: 44px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        button:focus {
            outline: 2px solid #4a00e0;
            outline-offset: 2px;
        }
        
        .broken-part {
            position: absolute;
            width: 40px;
            height: 40px;
            background: rgba(255, 0, 0, 0.7);
            border-radius: 5px;
            animation: pulse 2s infinite;
            pointer-events: none;
            z-index: 1;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 0.3; }
            100% { opacity: 0.7; }
        }
        
        .slot {
            position: absolute;
            width: 50px;
            height: 50px;
            border: 2px dashed #4a00e0;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #4a00e0;
            font-size: 1.5rem;
            background-color: rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 2;
        }
        
        .slot.highlight {
            border: 2px solid #ffeb3b;
            background-color: rgba(255, 235, 59, 0.3);
            box-shadow: 0 0 10px #ffeb3b;
        }
        
        .slot.placed {
            border: 2px solid #ff9800;
            background-color: rgba(255, 152, 0, 0.3);
        }
        
        .slot.correct {
            border: 2px solid #4caf50;
            background-color: rgba(76, 175, 80, 0.3);
            animation: correctPulse 1s ease-in-out;
        }
        
        .slot.incorrect {
            border: 2px solid #f44336;
            background-color: rgba(244, 67, 54, 0.3);
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .slot img {
            width: 40px;
            height: 40px;
            object-fit: contain;
            pointer-events: none;
        }
        
        .success-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            z-index: 100;
            display: none;
            width: 90%;
            max-width: 300px;
        }
        
        .success-message h2 {
            color: #4a00e0;
            margin-bottom: 15px;
            font-size: clamp(1.3rem, 4vw, 1.5rem);
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 99;
            display: none;
        }
        
        .part-hint {
            margin-top: 10px;
            font-size: clamp(0.8rem, 2.5vw, 0.9rem);
            color: #666;
        }
        
        .test-button {
            margin-top: 15px;
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .experience-area {
                flex-direction: column;
            }
            
            .music-box-container, .toolbox {
                min-width: 100%;
            }
            
            .experience-info {
                flex-direction: column;
                text-align: center;
                gap: 8px;
            }
            
            .tools {
                gap: 10px;
            }
            
            .tool {
                width: 65px;
                height: 65px;
            }
            
            .tool img {
                width: 45px;
                height: 45px;
            }
            
            .music-box {
                height: 220px;
            }
        }
        
        @media (max-width: 480px) {
            .experience-container {
                padding: 15px;
            }
            
            .music-box-container, .toolbox {
                padding: 15px;
            }
            
            .tools {
                gap: 8px;
            }
            
            .tool {
                width: 60px;
                height: 60px;
            }
            
            .tool img {
                width: 40px;
                height: 40px;
            }
            
            .music-box {
                height: 200px;
            }
            
            button {
                padding: 10px 18px;
            }
        }
        
        /* iPhone notch safe areas */
        @supports (padding: max(0px)) {
            .experience-container {
                padding-left: max(20px, env(safe-area-inset-left));
                padding-right: max(20px, env(safe-area-inset-right));
                padding-bottom: max(20px, env(safe-area-inset-bottom));
            }
        }
        
        /* 防止iOS缩放 */
        input, textarea, select {
            font-size: 16px;
        }
        
        /* 高对比度模式支持 */
        @media (prefers-contrast: high) {
            .tool {
                border: 1px solid #000;
            }
            
            .slot {
                border-width: 3px;
            }
        }
        
        /* 减少动画模式支持 */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            
            .broken-part {
                animation: none;
                opacity: 0.7;
            }
            
            .slot.correct, .slot.incorrect {
                animation: none;
            }
        }
    </style>
</head>
<body>
    <div class="experience-container">
        <header>
            <h1>音乐盒修复</h1>
            <p>诊断问题，选择正确的零件，修复音乐盒！</p>
        </header>
        
        <div class="experience-info">
            <div class="part-info">部分: <span id="part">1</span>/3</div>
            <div class="progress-info">进度: <span id="progress">0</span>%</div>
        </div>
        
        <div class="experience-area">
            <div class="music-box-container">
                <h2>损坏的音乐盒</h2>
                <div class="music-box" id="music-box">
                    <!-- 损坏部件和插槽将通过JavaScript动态生成 -->
                </div>
                <button id="test-button" class="test-button">测试音乐盒</button>
                <p class="part-hint">点击工具选择零件，然后点击闪烁的红色区域放置</p>
                <p class="part-hint">测试后可自动取消放置</p>
                <p class="part-hint">点击"测试音乐盒"验证修复是否正确</p>
            </div>
            
            <div class="toolbox">
                <h2>工具箱</h2>
                <div class="tools">
                    <div class="tool spring" data-type="spring" role="button" tabindex="0" aria-label="选择发条">
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjZmZlYjNmIi8+PGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMjAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSIyIi8+PHBhdGggZD0iTTMyIDEyYzAgMC0xMCAxMC0xMCAyMHMxMCAyMCAxMCAyMCAxMC0xMCAxMC0yMFM0MiAxMiAzMiAxMnoiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSIyIi8+PC9zdmc+" alt="发条">
                    </div>
                    <div class="tool gear" data-type="gear" role="button" tabindex="0" aria-label="选择齿轮">
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjZTBkZGRkIi8+PGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMjAiIGZpbGw9IiNmZmYiLz48Y2lyY2xlIGN4PSIzMiIgY3k9IjMyIiByPSIxNSIgZmlsbD0iI2UwZGRkZCIvPjxjaXJjbGUgY3g9IjMyIiBjeT0iMzIiIHI9IjUiIGZpbGw9IiNmZmYiLz48cGF0aCBkPSJNMzIgMTJ2LThNMzIgNTJ2LThNMTIgMzJoLThNNTIgMzJoLThNMTggMThsNi02TTQwIDQwbDYtNk0xOCA0Nmw2IDZNNDAgMjRsNiA2IiBzdHJva2U9IiMzMzMiIHN0cm9rZS13aWR0aD0iMiIvPjwvc3ZnPg==" alt="齿轮">
                    </div>
                    <div class="tool key" data-type="key" role="button" tabindex="0" aria-label="选择钥匙">
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjZmY5ODAwIi8+PGNpcmNsZSBjeD0iNDAiIGN5PSIyNCIgcj0iMTIiIGZpbGw9IiNmZmYiLz48cGF0aCBkPSJNMTYgNDBoLTR2LTRoNHY0ek0yMCAzNmg0djRIMjB6TTI0IDMzaDR2NGgtNHpNMjggMjhoNHY0aC00ek0zMiAyNGg4djhoLTh6IiBmaWxsPSIjZmY5ODAwIi8+PC9zdmc+" alt="钥匙">
                    </div>
                    <div class="tool cylinder" data-type="cylinder" role="button" tabindex="0" aria-label="选择音筒">
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjNzk1NTQ4Ii8+PHJlY3QgeD0iMTIiIHk9IjEwIiB3aWR0aD0iNDAiIGhlaWdodD0iNDQiIHJ4PSI1IiByeT0iNSIgZmlsbD0iI2UwZGRkZCIvPjxwYXRoIGQ9Ik0xOCAxNmg0TTE4IDI0aDRNMTggMzJoNE0xOCA0MGg0TTI2IDE2aDRNMjYgMjRoNE0yNiAzMmg0TTI2IDQwaDRNMzQgMTZoNE0zNCAyNGg0TTM0IDMzaDRNMzQgNDBoNCIgc3Ryb2tlPSIjOTk5IiBzdHJva2Utd2lkdGg9IjIiLz48L3N2Zz4=" alt="音筒">
                    </div>
                </div>
                
                <div class="instructions">
                    <h2>操作说明</h2>
                    <p>1. 观察音乐盒上闪烁的红色区域，这些是损坏的零件</p>
                    <p>2. 从工具箱中点击选择正确的零件</p>
                    <p>3. 点击闪烁的红色区域放置零件</p>
                    <p>4. 点击"测试音乐盒"验证修复是否正确</p>
                    <p>5. 已放置的错误零件会自动取消放置</p>
                    <p>6. 所有零件正确修复后自动进入下一部分</p>
                </div>
                
                <div class="controls">
                    <button id="reset-button">重新开始</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="overlay" id="overlay"></div>
    
    <div class="success-message" id="success-message">
        <h2>修复成功！</h2>
        <p>你成功修复了音乐盒的这一部分！</p>
        <button id="next-part">下一部分</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 体验状态
            const experienceState = {
                part: 1,
                progress: 0,
                brokenParts: 2,
                placedParts: 0,
                currentParts: [],
                slots: [],
                slotPositions: [],
                selectedTool: null,
                lastClickTime: 0,
                tested: false,
                isProcessingClick: false // 防止快速连续点击
            };
            
            // DOM元素
            const partElement = document.getElementById('part');
            const progressElement = document.getElementById('progress');
            const testButton = document.getElementById('test-button');
            const resetButton = document.getElementById('reset-button');
            const nextPartButton = document.getElementById('next-part');
            const successMessage = document.getElementById('success-message');
            const overlay = document.getElementById('overlay');
            const tools = document.querySelectorAll('.tool');
            const musicBox = document.getElementById('music-box');
            
            // 零件类型和对应的信息
            const partTypes = {
                'spring': { name: '发条', image: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjZmZlYjNmIi8+PGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMjAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSIyIi8+PHBhdGggZD0iTTMyIDEyYzAgMC0xMCAxMC0xMCAyMHMxMCAyMCAxMCAyMCAxMC0xMCAxMC0yMFM0MiAxMiAzMiAxMnoiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSIyIi8+PC9zdmc+' },
                'gear': { name: '齿轮', image: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjZTBkZGRkIi8+PGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMjAiIGZpbGw9IiNmZmYiLz48Y2lyY2xlIGN4PSIzMiIgY3k9IjMyIiByPSIxNSIgZmlsbD0iI2UwZGRkZCIvPjxjaXJjbGUgY3g9IjMyIiBjeT0iMzIiIHI9IjUiIGZpbGw9IiNmZmYiLz48cGF0aCBkPSJNMzIgMTJ2LThNMzIgNTJ2LThNMTIgMzJoLThNNTIgMzJoLThNMTggMThsNi02TTQwIDQwbDYtNk0xOCA0Nmw2IDZNNDAgMjRsNiA2IiBzdHJva2U9IiMzMzMiIHN0cm9rZS13aWR0aD0iIi8+PC9zdmc+' },
                'key': { name: '钥匙', image: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjZmY5ODAwIi8+PGNpcmNsZSBjeD0iNDAiIGN5PSIyNCIgcj0iMTIiIGZpbGw9IiNmZmYiLz48cGF0aCBkPSJNMTYgNDBoLTR2LTRoNHY0ek0yMCAzNmg0djRIMjB6TTI0IDMzaDR2NGgtNHpNMjggMjhoNHY0aC00ek0zMiAyNGg4djhoLTh6IiBmaWxsPSIjZmY5ODAwIi8+PC9zdmc+' },
                'cylinder': { name: '音筒', image: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjNzk1NTQ4Ii8+PHJlY3QgeD0iMTIiIHk9IjEwIiB3aWR0aD0iNDAiIGhlaWdodD0iNDQiIHJ4PSI1IiByeT0iNSIgZmlsbD0iI2UwZGRkZCIvPjxwYXRoIGQ9Ik0xOCAxNmg0TTE4IDI0aDRNMTggMzJoNE0xOCA0MGg0TTI2IDE2aDRNMjYgMjRoNE0yNiAzMmg0TTI2IDQwaDRNMzQgMTZoNE0zNCAyNGg0TTM0IDMzaDRNMzQgNDBoNCIgc3Ryb2tlPSIjOTk5IiBzdHJva2Utd2lkdGg9IjIiLz48L3N2Zz4=' }
            };
            
            // 初始化体验
            function initExperience() {
                generatePart();
                updateUI();
                setupEventListeners();
            }
            
            // 生成部分
            function generatePart() {
                // 清空音乐盒
                musicBox.innerHTML = '';
                experienceState.slots = [];
                experienceState.slotPositions = [];
                experienceState.placedParts = 0;
                experienceState.selectedTool = null;
                experienceState.tested = false;
                experienceState.isProcessingClick = false;
                
                // 根据部分确定损坏部件数量
                experienceState.brokenParts = Math.min(2 + experienceState.part - 1, 4);
                
                // 生成损坏部件和插槽
                for (let i = 0; i < experienceState.brokenParts; i++) {
                    let top, left;
                    let attempts = 0;
                    const minDistance = 70; // 最小间距
                    const padding = 30; // 距离边缘的最小距离
                    
                    // 确保位置不重叠且在音乐盒范围内
                    do {
                        top = padding + Math.random() * (190 - padding * 2);
                        left = padding + Math.random() * (190 - padding * 2);
                        attempts++;
                        
                        if (attempts > 100) break; // 防止无限循环
                    } while (experienceState.slotPositions.some(pos => 
                        Math.sqrt(Math.pow(pos.top - top, 2) + Math.pow(pos.left - left, 2)) < minDistance
                    ));
                    
                    // 存储位置
                    experienceState.slotPositions.push({ top, left });
                    
                    // 创建损坏部件
                    const brokenPart = document.createElement('div');
                    brokenPart.className = 'broken-part';
                    brokenPart.style.top = `${top}px`;
                    brokenPart.style.left = `${left}px`;
                    brokenPart.setAttribute('aria-label', `损坏的零件 ${i+1}`);
                    musicBox.appendChild(brokenPart);
                    
                    // 创建插槽
                    const slot = document.createElement('div');
                    slot.className = 'slot';
                    slot.style.top = `${top - 5}px`;
                    slot.style.left = `${left - 5}px`;
                    slot.dataset.index = i;
                    slot.innerHTML = '?';
                    slot.setAttribute('aria-label', `零件插槽 ${i+1}`);
                    musicBox.appendChild(slot);
                    
                    // 随机选择需要的零件类型
                    const partKeys = Object.keys(partTypes);
                    const requiredPart = partKeys[Math.floor(Math.random() * partKeys.length)];
                    
                    // 存储插槽信息
                    experienceState.slots.push({
                        element: slot,
                        requiredPart: requiredPart,
                        isPlaced: false,
                        placedPart: null,
                        isCorrect: false,
                        isTested: false
                    });
                }
                
                // 存储当前部分需要的零件
                experienceState.currentParts = experienceState.slots.map(slot => slot.requiredPart);
                
                // 重置工具选择状态
                tools.forEach(tool => tool.classList.remove('selected'));
                
                // 重置测试按钮状态
                testButton.textContent = '测试音乐盒';
                testButton.disabled = false;
            }
            
            // 更新UI
            function updateUI() {
                partElement.textContent = experienceState.part;
                progressElement.textContent = experienceState.progress;
            }
            
            // 设置事件监听器
            function setupEventListeners() {
                // 为工具设置点击事件
                tools.forEach(tool => {
                    // 点击事件
                    tool.addEventListener('click', function() {
                        selectTool(tool);
                    });
                    
                    // 键盘事件
                    tool.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            selectTool(tool);
                        }
                    });
                });
                
                // 为音乐盒设置点击事件
                musicBox.addEventListener('click', function(e) {
                    handleMusicBoxClick(e);
                });
                
                // 为音乐盒设置触摸事件
                musicBox.addEventListener('touchend', function(e) {
                    // 阻止默认行为防止双击缩放
                    e.preventDefault();
                    handleMusicBoxClick(e);
                }, { passive: false });
                
                // 测试按钮事件
                testButton.addEventListener('click', function() {
                    testMusicBox();
                });
                
                // 重置按钮事件
                resetButton.addEventListener('click', resetPart);
                
                // 下一部分按钮事件
                nextPartButton.addEventListener('click', function() {
                    if (experienceState.part < 3) {
                        experienceState.part++;
                        successMessage.style.display = 'none';
                        overlay.style.display = 'none';
                        resetPart();
                    } else {
                        // 修复完成后跳转到"一张字条.html"
                        window.location.href = "https://sylvie-seven-cq.top/Syzygy/音乐盒字条.html";
                    }
                });
            }
            
            // 选择工具
            function selectTool(tool) {
                // 取消之前选中的工具
                tools.forEach(t => t.classList.remove('selected'));
                
                // 选中当前工具
                tool.classList.add('selected');
                experienceState.selectedTool = tool.dataset.type;
                
                // 高亮显示可放置的插槽
                experienceState.slots.forEach(slot => {
                    if (!slot.isPlaced || (slot.isTested && !slot.isCorrect)) {
                        slot.element.classList.add('highlight');
                    }
                });
            }
            
            // 处理音乐盒点击
            function handleMusicBoxClick(e) {
                // 防止快速连续点击
                if (experienceState.isProcessingClick) return;
                experienceState.isProcessingClick = true;
                
                if (!experienceState.selectedTool) {
                    alert('请先选择一个工具！');
                    experienceState.isProcessingClick = false;
                    return;
                }
                
                // 获取点击位置
                const rect = musicBox.getBoundingClientRect();
                let x, y;
                
                if (e.type === 'touchend') {
                    x = e.changedTouches[0].clientX;
                    y = e.changedTouches[0].clientY;
                } else {
                    x = e.clientX;
                    y = e.clientY;
                }
                
                // 找到点击的插槽
                const slot = findClickedSlot(x, y);
                if (slot) {
                    // 检查是否是双击
                    const now = Date.now();
                    if (now - experienceState.lastClickTime < 300) {
                        // 双击 - 取消放置
                        cancelPlacement(slot);
                    } else {
                        // 单击 - 放置零件
                        placePart(slot);
                    }
                    experienceState.lastClickTime = now;
                }
                
                // 重置点击处理状态
                setTimeout(() => {
                    experienceState.isProcessingClick = false;
                }, 100);
            }
            
            // 放置零件
            function placePart(slot) {
                // 如果已经测试过且正确，不允许重新放置
                if (slot.isTested && slot.isCorrect) {
                    return;
                }
                
                // 放置零件
                const img = document.createElement('img');
                img.src = partTypes[experienceState.selectedTool].image;
                img.alt = partTypes[experienceState.selectedTool].name;
                slot.element.innerHTML = '';
                slot.element.appendChild(img);
                slot.element.classList.add('placed');
                slot.element.classList.remove('highlight');
                slot.element.classList.remove('correct');
                slot.element.classList.remove('incorrect');
                slot.isPlaced = true;
                slot.placedPart = experienceState.selectedTool;
                slot.isTested = false;
                experienceState.placedParts++;
                
                // 更新进度
                experienceState.progress = Math.floor((experienceState.placedParts / experienceState.brokenParts) * 100);
                updateUI();
                
                // 移除对应的损坏部件
                const brokenParts = document.querySelectorAll('.broken-part');
                if (brokenParts[slot.element.dataset.index]) {
                    brokenParts[slot.element.dataset.index].style.display = 'none';
                }
            }
            
            // 取消放置
            function cancelPlacement(slot) {
                // 如果已经测试过且正确，不允许取消
                if (slot.isTested && slot.isCorrect) {
                    return;
                }
                
                // 取消放置
                slot.element.innerHTML = '?';
                slot.element.classList.remove('placed');
                slot.element.classList.remove('correct');
                slot.element.classList.remove('incorrect');
                slot.isPlaced = false;
                slot.placedPart = null;
                slot.isCorrect = false;
                slot.isTested = false;
                experienceState.placedParts--;
                
                // 更新进度
                experienceState.progress = Math.floor((experienceState.placedParts / experienceState.brokenParts) * 100);
                updateUI();
                
                // 显示对应的损坏部件
                const brokenParts = document.querySelectorAll('.broken-part');
                if (brokenParts[slot.element.dataset.index]) {
                    brokenParts[slot.element.dataset.index].style.display = 'block';
                }
            }
            
            // 测试音乐盒
            function testMusicBox() {
                if (experienceState.placedParts < experienceState.brokenParts) {
                    alert(`请先放置所有零件！还需要放置 ${experienceState.brokenParts - experienceState.placedParts} 个零件。`);
                    return;
                }
                
                experienceState.tested = true;
                testButton.disabled = true;
                testButton.textContent = '测试中...';
                
                let allCorrect = true;
                let correctCount = 0;
                
                // 检查每个插槽的零件是否正确
                experienceState.slots.forEach(slot => {
                    slot.isTested = true;
                    if (slot.placedPart === slot.requiredPart) {
                        slot.isCorrect = true;
                        slot.element.classList.add('correct');
                        correctCount++;
                    } else {
                        slot.isCorrect = false;
                        slot.element.classList.add('incorrect');
                        allCorrect = false;
                        
                        // 错误的零件自动重置，允许重新放置
                        setTimeout(() => {
                            slot.element.classList.remove('incorrect');
                            slot.element.classList.remove('placed');
                            slot.element.innerHTML = '?';
                            slot.isPlaced = false;
                            slot.placedPart = null;
                            
                            // 显示对应的损坏部件
                            const brokenParts = document.querySelectorAll('.broken-part');
                            if (brokenParts[slot.element.dataset.index]) {
                                brokenParts[slot.element.dataset.index].style.display = 'block';
                            }
                        }, 1500);
                    }
                });
                
                // 更新进度
                experienceState.progress = Math.floor((correctCount / experienceState.brokenParts) * 100);
                updateUI();
                
                setTimeout(() => {
                    if (allCorrect) {
                        completePart();
                    } else {
                        // 更新已放置零件数量
                        experienceState.placedParts = correctCount;
                        testButton.textContent = '重新测试';
                        testButton.disabled = false;
                        alert(`修复不完全正确！${correctCount}/${experienceState.brokenParts} 个零件正确。错误的零件已自动移除，请重新放置。`);
                    }
                }, 500);
            }
            
            // 找到点击的插槽
            function findClickedSlot(x, y) {
                let minDistance = Infinity;
                let nearestSlot = null;
                
                experienceState.slots.forEach(slot => {
                    // 允许点击未放置的插槽，或者已经测试过但错误的插槽
                    if (!slot.isPlaced || (slot.isTested && !slot.isCorrect)) {
                        const rect = slot.element.getBoundingClientRect();
                        const centerX = rect.left + rect.width / 2;
                        const centerY = rect.top + rect.height / 2;
                        const distance = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
                        
                        if (distance < minDistance) {
                            minDistance = distance;
                            nearestSlot = slot;
                        }
                    }
                });
                
                return minDistance < 80 ? nearestSlot : null; // 80px为最大有效距离
            }
            
            // 完成部分
            function completePart() {
                successMessage.style.display = 'block';
                overlay.style.display = 'block';
            }
            
            // 重置部分
            function resetPart() {
                experienceState.placedParts = 0;
                experienceState.progress = 0;
                experienceState.selectedTool = null;
                experienceState.tested = false;
                experienceState.isProcessingClick = false;
                
                // 重新生成部分
                generatePart();
                
                updateUI();
            }
            
            // 初始化体验
            initExperience();
        });
    </script>
</body>
</html>
